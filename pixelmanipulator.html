<!doctype html>
<html>
	<head>
		<!--Declarations and types (media objs and favicons)-->
		<title>Pixel Manipulator</title>
		<!--CSS files-->
		<style>
		body{
			background-color:grey;
		}
		#canvas{/*This is where the pixels are being renderd*/
			position:fixed;
			top:0;
			left:0;
		}
		#zoom-box{/*This is the container for the zoomed-in box that the user can interact with*/
			position:fixed;
			top:0;
			right:0;
			z-index:999;
			height:100%
			overflow: scroll;
		}
		</style>
	</head>
	<body>
		<!--Content-->
		<canvas id="canvas"></canvas><!--This is the place where the pixels are rendered-->
		<div id="zoom-box"><!--This is the container for the zoomed-in box that the user can interact with-->
			<canvas id="zoom" width="400" height="400"></canvas><br/><!--This is the zoomed-in box that the user can interact with-->
			<input id="file" type="file" /><!--This is where the user can upload an image that will then applied to the canvas, and will allow for coming back from saving-->
			<button id="play" alt="Play/Resume/Rewind" title="Play/Resume">►</button><!--The play button that changes into a restart button when pressed, unless it's paused, then it's a play button again.-->
			<button id="pause" alt="Pause" title="Pause">▌▌</button><!--This pauses everything in #canvas-->
			<button id="oneFrameAtATime" onclick="loop();" alt="Next frame" title="Next frame">►▌</button><!--This executes the function called by setInterval in the play button once per click, iterating one frame at a time-->
			<!--button id="record" alt="Toggle Recording" title="Toggle Recording">•</button><!--This records #canvas as a .gif file and once clicked a second time, allows for the user to download the .gif. (it also resets the .gif if clicked again, and starts recoring again)-->
			<br/>
			Width: <input id="width"/><br/>
			Height: <input id="height" /><br/>
			Zoom Width: <input id="zoomWidthElm"/><br/>
			Zoom Height: <input id="zoomHeightElm"/><br/>
			<br/>
			Normal click: 
			<select class="elmDrop" onchange="normalClickChange(this)">
				<option>Acid</option>
				<option>Blocks</option>
				<option>Conductor</option>
				<option selected="selected">Conway's Game Of Life</option>
				<option>Electricity</option>
				<option>FadingElectricity</option>
				<option>No-loop Conway's Game Of Life</option>
				<option>Rule 110</option>
				<option>Water</option>
			</select>
			<br/>
			Ctrl click: 
			<select class="elmDrop" onchange="ctrlClickChange(this)">
				<option>Acid</option>
				<option selected="selected">Blocks</option>
				<option>Conductor</option>
				<option>Conway's Game Of Life</option>
				<option>Electricity</option>
				<option>FadingElectricity</option>
				<option>No-loop Conway's Game Of Life</option>
				<option>Rule 110</option>
				<option>Water</option>
			</select><br/>
			<span style="position:absolute; right:0px; bottom:0px">v1.0.0-alfa-38.100</span>
		</div>
		<!--script src="https://jnordberg.github.io/gif.js/gif.js?v=3"></script><!---->
		<!--script src="https://jnordberg.github.io/gif.js/gif.worker.js"></script><!---->
		<script>
var canvas = document.getElementById('canvas'),
	ctx = canvas.getContext('2d'),
	zoomelm = document.getElementById('zoom'),
	zoomctx = zoomelm.getContext('2d'),
	file = document.getElementById('file'),
	normalClick=[0,255,0,255],
	ctrlClick=[127,127,127,255],
	//recording=false,
	//gifsettings={workers: 2, workerScript:"https://jnordberg.github.io/gif.js/gif.worker.js", quality: 10},
	//gif={},
	elementTypeMap={
		"Acid":[110, 162, 10,255],
		"Blocks":[127,127,127,255],
		"Conductor":[67,75,77,255],
		"Conway's Game Of Life":[0,255,0,255],
		"Electricity":[148, 133, 0,255],
		"FadingElectricity":[148, 133, 0,254],
		"No-loop Conway's Game Of Life":[0,150,0,255],
		"Rule 110":[128,0,128,255],
		"Water":[23,103,167,255],
		"blank":[0,0,0,255]
	},
	imageData = ctx.getImageData(0, 0, canvas.width, canvas.height),
	data = imageData.data,
	mouseX,
	mouseY;
canvas.addEventListener('click', zoom);
function createGetPixel(d) {
	return (function (x,y,loop) {
	//               (#,#)
		loop=typeof loop!=="undefined"?loop:true;
		if (loop) {
			while (x<0) {
				x=canvas.width+x;
			}
			while (y<0) {
				y=canvas.height+y;
			}
			
			while (x>=canvas.width) {
				x=x-canvas.width;
			}
			while (y>=canvas.height) {
				y=y-canvas.height;
			}
		}else{
			if (x<0||x>=canvas.width||y<0||x>=canvas.height) return [127,127,127,255]
		}
		
		return d.slice(((canvas.width*y)+x)*4,(((canvas.width*y)+x)*4)+4);
	});
};
var getPixel=createGetPixel(data);
function setPixel(x,y,rgb,val,loop) {
/*               (#,#,#  ,#  )
rgb:
 0=red
 1=green
 2=blue
 3=alfa
*/
	loop=typeof loop!=="undefined"?loop:true;
	if (loop) {
		while (x<0) {
			x=canvas.width+x;
		}
		while (y<0) {
			y=canvas.height+y;
		}
		
		while (x>=canvas.width) {
			x=x-canvas.width;
		}
		while (y>=canvas.height) {
			y=y-canvas.height;
		}
	}else{
		if (x<0||x>=canvas.width||y<0||x>=canvas.height) return;
	}
	
	data[(((canvas.width*y)+x)*4)+rgb]=val;
};
function apply() {
	ctx.putImageData(imageData, 0, 0);
}

function makeConfirmColor(x,y,f,loop) {
	loop=typeof loop!=="undefined"?loop:true;
	var colors=f(x,y,loop);
	return function(r,g,b,a) {
		return colors[0]==(r||0)&&colors[1]==(g||0)&&colors[2]==(b||0)&&colors[3]==(a||0);
	}
}
function makeMooreNearbyCounter(x,y,f) {
	return (function (r,g,b,a,loop) {
		return (makeConfirmColor(x-1,y-1,f,loop)(r,g,b,a))+
		(makeConfirmColor(x-1,y,f,loop)(r,g,b,a))+
		(makeConfirmColor(x-1,y+1,f,loop)(r,g,b,a))+
		(makeConfirmColor(x,y-1,f,loop)(r,g,b,a))+
		(makeConfirmColor(x,y+1,f,loop)(r,g,b,a))+
		(makeConfirmColor(x+1,y-1,f,loop)(r,g,b,a))+
		(makeConfirmColor(x+1,y,f,loop)(r,g,b,a))+
		(makeConfirmColor(x+1,y+1,f,loop)(r,g,b,a));
	})
}
function setPixelSet(x,y,arry,loop) {
	for (var i=0; i<arry.length; i++) {
		setPixel(x,y,i,arry[i],loop);
	}
}
function loop() {
	var old=[];
	for (var i=0;i<data.length;i++) {
		old[i]=data[i]-0;
	}
	//throw old
	var getOldPixel=createGetPixel(old);
	for (var x=0; x<canvas.width; x++) {
		for (var y=0; y<canvas.height; y++) {
			var confirmColor=makeConfirmColor(x,y,getOldPixel);//initiallises a confirmColor(), that returns a bool of if this pixel is the inputted color
				mooreNearbyCounter=makeMooreNearbyCounter(x,y,getOldPixel);
			if (confirmColor(0,150,0,255)) {//no-loop conways game of life
				var nearbyTotalG=mooreNearbyCounter(0,150,0,255,false);
				if(nearbyTotalG<2||nearbyTotalG>=4) {
					setPixel(x,y,1,0);//Any alive cell that is touching less than two alive neighbours dies.
					//Any alive cell touching four or more alive neighbours dies.
				}
			}else if (confirmColor(0,255,0,255)) {//conways game of life
				var nearbyTotalG=mooreNearbyCounter(0,255,0,255);
				if(nearbyTotalG<2||nearbyTotalG>=4) {
					setPixel(x,y,1,0);//Any alive cell that is touching less than two alive neighbours dies.
					//Any alive cell touching four or more alive neighbours dies.
				}
			}else if (confirmColor(0,0,0,255)) {
				if(mooreNearbyCounter(0,150,0,255,false)===3) setPixelSet(x,y,[0,150,0,255]);//Any dead cell touching exactly three alive neighbours becomes alive.
				if(mooreNearbyCounter(0,255,0,255)===3) setPixelSet(x,y,[0,255,0,255]);//Any dead cell touching exactly three alive neighbours becomes alive.
			}else if (confirmColor(23,103,167,255)) {//water
				var rand=Math.round(Math.random()*2)-1,
					factor=0;
				while ((!makeConfirmColor(x+rand,y+factor,getOldPixel,false)(0,0,0,255))&&factor<2) factor++;
				if (factor<=2&&(makeConfirmColor(x+rand,y+factor,getPixel,false)(0,0,0,255))){
					setPixelSet(x,y,[0,0,0,255],false);
					setPixelSet(x+rand,y+factor,[23,103,167,255],false);
				}
			}else if (confirmColor(110,162,10,255)) {//acid
				var rand=Math.round(Math.random()*2)-1,
					factor=0;
				while ((!makeConfirmColor(x+rand,y+factor,getOldPixel,false)(0,0,0,255)||Math.random()<=.3)&&factor<3) factor++;
				if (factor<=3){
					if (Math.random()>.3) setPixelSet(x,y,[0,0,0,255],false);
					setPixelSet(x+rand,y+factor,[110,162,10,255],false);
				}
			}else if (confirmColor(148, 133, 0,254)) {//fadingelectricity
				setPixelSet(x,y,[67,75,77,255],false);
			}else if (confirmColor(148, 133, 0,255)) {//electricity
				setPixelSet(x,y,[148,133,0,254],false);
			}else if (confirmColor(67,75,77,255)) {//conductor
				var conductorNearbyTotal=mooreNearbyCounter(148, 133, 0,255,false);
				if(conductorNearbyTotal===1||conductorNearbyTotal===2) setPixelSet(x,y,[148,133,0,255]);//copper stays as copper unless it has just one or two neighbours that are electron heads, in which case it becomes an electron head
			}else if (confirmColor(127,127,127,255)) {
			}else{
				console.log("Nothing happened with",getOldPixel(x,y));
			}
		}
	}
	apply();
	zoom({
		layerX:mouseX,
		layerY:mouseY,
	});
};
var loopint=0;
file.addEventListener('change', function(e) {
    var img = new Image;
    img.src = URL.createObjectURL(e.target.files[0]);
    img.onload = function() {
        ctx.drawImage(this, 0,0);
		this.style.display = 'none';
		canvas = document.getElementById('canvas');
		canvas.width=document.getElementById("width").value||100;
		canvas.height=document.getElementById("height").value||100;
		canvas.width=document.getElementById("width").value||100;
		canvas.height=document.getElementById("height").value||100;
		ctx = canvas.getContext('2d');
		imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
		data=imageData.data;
        document.getElementById('pause').disabled=true;
    }
});
function setCanvasSizes() {
	canvas.width=document.getElementById("width").value||100;
	canvas.height=document.getElementById("height").value||100;
	zoomelm.width=(document.getElementById("zoomWidthElm").value||20)*20;
	zoomelm.height=(document.getElementById("zoomHeightElm").value||20)*20;
	imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
	data = imageData.data;
	ctx.imageSmoothingEnabled=false;
	ctx.mozImageSmoothingEnabled=false;
	ctx.webkitImageSmoothingEnabled=false;
	ctx.msImageSmoothingEnabled=false;
	zoomctx.imageSmoothingEnabled=false;
	zoomctx.mozImageSmoothingEnabled=false;
	zoomctx.webkitImageSmoothingEnabled=false;
	zoomctx.msImageSmoothingEnabled=false;
}
document.getElementById("play").addEventListener('click',function() {
	if (!document.getElementById('pause').disabled) {
		clearInterval(loopint);
		setCanvasSizes();
		for (var i=0; i < data.length; i+=4) {
			for (var ii=0; ii <=2; ii++) data[i+ii]=0;
			data[i+3]=255;
		}
		ctx.putImageData(imageData, 0, 0);
	}
	document.getElementById('pause').disabled = false;
	document.getElementById('play').innerHTML = "◄";
	loopint=setInterval(loop,1);
});
document.getElementById("pause").addEventListener('click',function() {
	document.getElementById('pause').disabled = true;
	document.getElementById('play').innerHTML = "►";
	clearInterval(loopint);
});
function ctrlClickChange(th) {
	ctrlClick=elementTypeMap[th.value];
}
function normalClickChange(th) {
	normalClick=elementTypeMap[th.value];
}
var zoomClick=function(e) {
	var old=[];
	for (var i=0;i<data.length;i++) {
		old[i]=data[i]-0;
	}
	var getOldPixel=createGetPixel(old);
	var zoomXPos=Math.floor(e.layerX/20)+(mouseX-10),
		zoomYPos=Math.floor(e.layerY/20)+(mouseY-10),
		confirmColor=makeConfirmColor(zoomXPos,zoomYPos,getOldPixel);
	if (e.ctrlKey) {
		if (confirmColor(ctrlClick[0],ctrlClick[1],ctrlClick[2],ctrlClick[3])) {	
			setPixelSet(zoomXPos,zoomYPos,[0,0,0,255]);
		}else{
			setPixelSet(zoomXPos,zoomYPos,ctrlClick);
		}
	}else{//green
		if (confirmColor(normalClick[0],normalClick[1],normalClick[2],normalClick[3])) {
			setPixelSet(zoomXPos,zoomYPos,[0,0,0,255]);
		}else{
			setPixelSet(zoomXPos,zoomYPos,normalClick);
		}
	}
	apply();
	zoom({
		layerX:mouseX,
		layerY:mouseY,
	});
};
document.getElementById('zoom').addEventListener('click',zoomClick);
document.getElementById('zoom').addEventListener('drag',zoomClick);

//loop();
function zoom(event) {
	mouseX = event.layerX;
	mouseY = event.layerY;	
	zoomctx.clearRect(0,0,zoomelm.width,zoomelm.height);
	zoomctx.drawImage(canvas,
					  (mouseX - 10),
					  (mouseY - 10),
					  (zoomelm.width/20), (zoomelm.height/20),
					  0, 0,
					  zoomelm.width, zoomelm.height);
	zoomctx.strokeStyle="gray";
	zoomctx.beginPath();
	for (var i=1; i<(zoomelm.width/20); i++) {
		zoomctx.moveTo(i*20,0);
		zoomctx.lineTo(i*20,zoomelm.height);
	}
	for (var i=1; i<(zoomelm.height/20); i++) {
		zoomctx.moveTo(0,i*20);
		zoomctx.lineTo(zoomelm.width,i*20);
	}
	zoomctx.stroke();
};
zoom({
	layerX:0,
	layerY:0,
});
		</script>
	</body>
</html>