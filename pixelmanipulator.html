<!doctype html>
<!--
	This is the advanced demo for PixelManipulator
    Copyright (C) 2018  Nathan Fritzler

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
	<head>
		<!--Declarations and types (media objs and favicons)-->
		<meta charset="utf-8">
		<title>Pixel Manipulator</title>
		<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
		<!--CSS files-->
		<style>
		body{
			background-color:grey;
			font-family: sans-serif;
		}
		#canvas{/*This is where the pixels are being renderd*/
			position:fixed;
			top:0;
			left:0;
		}
		#menu-box{
			position:fixed;
			top:0;
			right:0;
			z-index:999;
			height:100%;
			flex-direction:row;
			display:flex;
		}
		#menu-box>div{
			border-left:1px solid lightgrey;
		}
		#zoom-box{/*This is the container for the zoomed-in box that the user can interact with*/
			height:100%;
			flex-direction:column;
			display:flex;
		}
		#scroll-box{
			overflow-y:scroll;
		}
		#scroll-box>div{
			padding-bottom:1em;
		}
		#actions-box{
			border-bottom:1px solid lightgrey;
		}
		#selectorBox,/*This is the grey square on the left of the screen that shows where the zoom box is focused*/
		#smallxline,/*These are the lines that show where on the canvas the mouse cursor is hovering.*/
		#smallyline,
		#largexline,
		#largeyline,
		#largexline1,
		#largeyline1{
			position:absolute;
			background:rgba(128,128,128,.5);
			border:none;
		}
		#selectorBox:hover{
			border:solid rgba(255,255,255,.5) 1px;
		}
		input[type="text"]{
			text-align:right;
			width:3em;
		}
		.click-type-random{
			padding-left:1em
		}
		.hidden{
			display:none;
		}
		</style>
	</head>
	<body>
		<!--Content-->
		<canvas id="canvas"></canvas><!--This is the place where the pixels are rendered-->
		<div id="smallxline" style="width:1px; height:100%; top:0px;"></div>
		<div id="smallyline" style="height:1px; width:100%; left:0px;"></div>
		<div id="selectorBox"></div>
		<div id="menu-box">
			<div id="customizer" class="hidden"></div>
			<div id="zoom-box">
				<div id="zoom-container">
					<canvas id="zoom" width="400" height="400"></canvas><!--This is the zoomed-in box that the user can interact with-->
					<div id="largexline"></div>
					<div id="largeyline"></div>
					<div id="largexline1"></div>
					<div id="largeyline1"></div>
				</div>
				<div id="actions-box">
					<button id="reset" alt="Reset" title="Reset">◄</button>
					<button id="play" alt="Play" title="Play" disabled>►</button><!--The play button that changes into a restart button when pressed,unless it's paused,then it's a play button again.-->
					<button id="pause" alt="Pause" title="Pause" disabled>▌▌</button><!--This pauses everything in #canvas-->
					<button id="oneFrameAtATime" onclick="p.iterate();" alt="Next frame" title="Next frame" disabled>►▌</button><!--This executes the function called by setInterval in the play button once per click,iterating one frame at a time-->
				</div>
				<div id="scroll-box">
					<div id="sizes-box">
						<div>Width: <input id="width" type="text" value="100" placeholder="100" title="Default:100"/>px</div>
						<div>Height: <input id="height" type="text" value="100" placeholder="100" title="Default:100"/>px</div>
						<div>Zoom Width: <input id="zoomWidthElm" type="text" value="20" placeholder="70" title="Default:20"/>px</div>
						<div>Zoom Height: <input id="zoomHeightElm" type="text" value="20" placeholder="70" title="Default:20"/>px</div>
					</div>
					<div id="click-types">
						<div class="click-type">
							Normal click:
							<select class="elmDrop" id="normalSelect"></select>
							<div class="click-type-random">
								<button id="normalFill">Randomly fill</button>
								<input id="normalFillP" type="text" value="15" placeholder="15"/>%
							</div>
						</div>
						<div class="click-type">
							Ctrl click:
							<select class="elmDrop" id="ctrlSelect"></select>
							<div class="click-type-random">
								<button id="ctrlFill">Randomly fill</button>
								<input id="ctrlFillP" type="text" value="15" placeholder="15"/>%
							</div>
						</div>
						<div class="click-type">
							Alt click:
							<select class="elmDrop" id="altSelect"></select>
							<div class="click-type-random">
								<button id="altFill">Randomly fill</button>
								<input id="altFillP" type="text" value="15" placeholder="15"/>%
							</div>
						</div>
					</div>
					<table>
						<tr>
							<td>
								<label>
									<input id="shtargeter" type="checkbox">
									Hide targeter lines
								</label>
							</td>
							<td>
								<label>
									<input id="shfocusbox" type="checkbox">
									Hide focus box
								</label>
							</td>
						</tr>
						<tr>
							<td>
								<label>
									<input id="pixelCounterT" type="checkbox">
									Hide pixelCounter
								</label>
							</td>
							<td>
								<label>
									<input id="customizeT" type="checkbox">
									Show element customizer
								</label>
							</td>
						</tr>
					</table>
					<div id="callout">
						<div>
							<a target="_blank" href="https://github.com/Lazerbeak12345/pixelmanipulator">View Pixelmanipulator On GitHub!</a>
						</div>
						<!-- Frontend will be 2.0.0 when I refresh the GUI's look. -->
						Library v<span id="backendversion"></span>, Frontend v1.29.0
					</div><!--The frontend version is different because there are changes that don't impact the rest of the library -->
				</div>
			</div>
		</div>
		<div id="pixelCounter" style="position:absolute; bottom:0px; text-align:left; left:0px;"></div>
		<script src="pixelmanipulator.js"></script>
		<script>
			function ready(callback){ //the original was from https://stackoverflow.com/a/7053197 , but I added returns in order to speed up the prossess.
				// in case the document is already rendered
				if (document.readyState!='loading') {callback(); return;}
				// modern browsers
				if (document.addEventListener) {document.addEventListener('DOMContentLoaded', callback); return;}
				// IE <= 8
				document.attachEvent('onreadystatechange', function(){
					if (document.readyState=='complete') callback();
				});
			}
			var //file = document.getElementById('file'),
				timedebug=true,
				//times=[],
				//lasttime=NaN,
				frames=0;
			function updateBox() {
				var selectorboxSty=document.getElementById('selectorBox').style;
				selectorboxSty.width=(p.zoomelm.width/p.zoomScaleFactor)+"px";
				selectorboxSty.height=(p.zoomelm.height/p.zoomScaleFactor)+"px";
				selectorboxSty.left=(p.zoomX-(p.zoomelm.width/(2*p.zoomScaleFactor)))+"px";
				selectorboxSty.top=(p.zoomY-(p.zoomelm.height/(2*p.zoomScaleFactor)))+"px";
			}
			function updateSmallLines(e) {
				document.getElementById('smallxline').style.left=(e.pageX)+"px";
				document.getElementById('smallyline').style.top=(e.pageY)+"px";
				var x=e.pageX-p.zoomX+(p.zoomScaleFactor/2),
					y=e.pageY-p.zoomY+(p.zoomScaleFactor/2);
				if ((e.pageX<((p.zoomelm.width/ (2*p.zoomScaleFactor))+p.zoomX)&&e.pageX>((p.zoomelm.width/ (-2*p.zoomScaleFactor))+p.zoomX))) {
				  	//for when the line is inside the box, but the cursor isn't.
				  	updateLargeLinesX(x,y);
				}else updateLargeLinesX(-1,y)
				if ((e.pageY<((p.zoomelm.height/(2*p.zoomScaleFactor))+p.zoomY)&&e.pageY>((p.zoomelm.height/(-2*p.zoomScaleFactor))+p.zoomY))) {
					updateLargeLinesY(x,y);
				}else updateLargeLinesY(x,-1);

			}
			function updateLargeLinesX(x,y) {
				var zh=p.zoomelm.height,
					zw=p.zoomelm.width,
					zsf=p.zoomScaleFactor,
					h=(zh-((1+y)*zsf)),
					t=zsf*(y+1),
					h2=(y*zsf),
					rightVal=zw-zsf*(x+1);
				if (y<0||y>(zh/zsf)) {
					h=zh;
					t=0;
					h2=0;
				}

				var largexlinesty=document.getElementById("largexline").style;
				largexlinesty.width=p.zoomScaleFactor+"px";
				largexlinesty.height=h+"px";
				largexlinesty.right=rightVal+"px";
				largexlinesty.top=t+"px";

				var largexline1sty=document.getElementById("largexline1").style;
				largexline1sty.width=p.zoomScaleFactor+"px";
				largexline1sty.height=h2+"px";
				largexline1sty.right=rightVal+"px";
				largexline1sty.top=0;
			}
			function updateLargeLinesY(x,y) {
				var zh=p.zoomelm.height,
					zw=p.zoomelm.width,
					zsf=p.zoomScaleFactor,
					w=zw-((1+x)*zsf),
					l=zw-zsf*x,
					w2=(x*zsf);
				if (x<0||x>(zw/zsf)) {
					w=zw;
					l=0;
					w2=0;
				}

				var largeylinesty=document.getElementById("largeyline").style;
				largeylinesty.height=p.zoomScaleFactor+"px";
				largeylinesty.width=w+"px";
				largeylinesty.top=p.zoomScaleFactor*y+"px";
				largeylinesty.right=0;

				var largeyline1sty=document.getElementById("largeyline1").style;
				largeyline1sty.height=p.zoomScaleFactor+"px";
				largeyline1sty.width=w2+"px";
				largeyline1sty.top=p.zoomScaleFactor*y+"px";
				largeyline1sty.right=l+"px";
			}
			function selectorClicked(e) {
				p.zoom({
					x:e.pageX,
					y:e.pageY,
				});
				updateBox();
			}
			function updateBothLargeLines(e) {
				var x=Math.floor(e.offsetX/p.zoomScaleFactor),
					y=Math.floor(e.offsetY/p.zoomScaleFactor);
				updateSmallLines({
					pageX:x+p.zoomX-(p.zoomelm.width/(2*p.zoomScaleFactor)),
					pageY:y+p.zoomY-(p.zoomelm.width/(2*p.zoomScaleFactor)),
				});
			};
			function bigLineGotHovered(e) {
				e.target.style.height="0px";//get the element out of the way so the canvas below will A: still be clickable and B: move this elm to the correct place
			}
			function boxHoverOrClick(e) {
				updateSmallLines(e);
				updateLargeLinesX(e.offsetX,e.offsetY);
				updateLargeLinesY(e.offsetX,e.offsetY);
			};
			ready(function() {
				document.getElementById("backendversion").innerText=p.version
				p.canvasPrep({
					canvas:document.getElementById('canvas'),
					zoom:document.getElementById('zoom'),
				});
				window.pixelManipulator.canvas.addEventListener('click',function(event) {
					window.pixelManipulator.zoom({
						x:event.offsetX,
						y:event.offsetY,
					});
				});
				window.pixelManipulator.zoomelm.addEventListener('click',zoomClick);
				window.pixelManipulator.zoomelm.addEventListener('drag',zoomClick);
				var selectorBoxElm=document.getElementById('selectorBox'),//define these before, as they are used multiple times
					smallxlineElm=document.getElementById('smallxline'),
					smallylineElm=document.getElementById('smallyline'),
					largexlineElm=document.getElementById('largexline'),
					largexline1Elm=document.getElementById('largexline1'),
					largeylineElm=document.getElementById('largeyline'),
					largeyline1Elm=document.getElementById('largeyline1'),
					shtargeterElm=document.getElementById('shtargeter'),
					shfocusboxElm=document.getElementById('shfocusbox'),
					customizer=document.getElementById('customizer');
				p.canvas.addEventListener('click', updateBox);
				selectorBoxElm.addEventListener('click',selectorClicked);
				p.canvas.addEventListener('mousemove', updateSmallLines);
				selectorBoxElm.addEventListener('mousemove', boxHoverOrClick);
				selectorBoxElm.addEventListener('click', boxHoverOrClick);
				smallxlineElm.addEventListener('mousemove', updateSmallLines);
				smallylineElm.addEventListener('mousemove', updateSmallLines);
				smallxlineElm.addEventListener('click',selectorClicked);
				smallylineElm.addEventListener('click',selectorClicked);
				p.zoomelm.addEventListener('mousemove',updateBothLargeLines);
				largexlineElm.addEventListener('mousemove',bigLineGotHovered);
				largexline1Elm.addEventListener('mousemove',bigLineGotHovered);
				largeylineElm.addEventListener('mousemove',bigLineGotHovered);
				largeyline1Elm.addEventListener('mousemove',bigLineGotHovered);
				shtargeterElm.addEventListener('click',function() {
					var state=shtargeterElm.checked?"hidden":"visible";
					smallxlineElm.style.visibility=state;
					smallylineElm.style.visibility=state;
					largexlineElm.style.visibility=state;
					largexline1Elm.style.visibility=state;
					largeylineElm.style.visibility=state;
					largeyline1Elm.style.visibility=state;
				});
				shfocusboxElm.addEventListener('click',function() {
					var state=shfocusboxElm.checked?"hidden":"visible";
					selectorBoxElm.style.visibility=state;
				});
				document.getElementById('customizeT').addEventListener('click',function() {
					if(this.checked){
						customizer.classList=[];
					}else{
						customizer.classList=["hidden"]
					}
				});
				p.zoomX=10;
				p.zoomY=10;
				p.addMultipleElements({//*
					"Acid":{
						color:[110,162,10,255],
						liveCell:function(rel) {//current Pixel Matches
							var rands_acid=new Uint8Array(3)
							window.crypto.getRandomValues(rands_acid);
							var newx=rel.x+(rands_acid[0]%3)-1,
								newy=rel.y+rands_acid[1]%4,
								h=p.get_height();
							while((newy>=h||p.confirmElm(newx,newy,rel.oldId,false))&&newy-1>=rel.y)
								newy--
							if(!p.confirmElm(newx,newy,rel.oldId,false)){
								p.setPixel(rel.x,rel.y,p.defaultId,false);
								p.setPixel(newx,newy,rel.oldId,false)
							}else if(rands_acid[2]%100===0)p.setPixel(newx,newy,p.defaultId)
						},
					},
					"Blocks":{//does nothing
						color:[127,127,127,255],
					},
					"Brian's Brain (dying)":{
						color:[254,254,254,255], //not quite white
						liveCell:function(rel) {
							p.setPixel(rel.x,rel.y,p.defaultId,false);//Cells that were in the dying state go into the off state
						},
					},
					"Brian's Brain (on)":{
						color:[0,0,254,255],//not quite blue
						liveCell:function(rel) {//All cells that were "on" go into the "dying" state, which is not counted as an "on" cell in the neighbor count, and prevents any cell from being born there.
							p.setPixel(rel.x,rel.y,"Brian's Brain (dying)",false);
						},
						pattern:"B2/S",//same pattern as seeds
					},
					"Seeds":{
						color:[194, 178, 128],
						pattern:"B2/S",
					},
					"Conway's Game Of Life":{
						color:[0,255,0,255],
						pattern:"B3/S23",//born on 3, survives on 2 or 3
					},//*
					"Wireworld Conductor":{
						color:[67,75,77,255],
						liveCell:function(rel) {
							var num=p.elementTypeMap["Wireworld Electricity"].number;
							var conductorNearbyTotal=rel.mooreNearbyCounter(rel.x,rel.y,num);
							//copper stays as copper unless it has just one or two neighbours that are electron heads,in which case it becomes an electron head
							if(conductorNearbyTotal===1||conductorNearbyTotal===2)
								p.setPixel(rel.x,rel.y,num);
						}
					},
					"Wireworld Electricity":{
						color:[148,133,0,255],
						liveCell:function(rel) {
							p.setPixel(rel.x,rel.y,"Wireworld FadingElectricity",false);
						}
					},
					"Wireworld FadingElectricity":{
						color:[148,133,0,254],
						liveCell:function(rel) {
							p.setPixel(rel.x,rel.y,"Wireworld Conductor",false);
						}
					},
					"Highlife":{
						color:[0,255,128,255],
						pattern:"B36/S23"//born on 3 or 6, survives on 2 or 3
					},
					"No-loop Conway's Game Of Life":{
						color:[0,150,0,255],
						pattern:"B3/S23",//same as Conway's Game Of Life, but with a no-loop boolean
						loop:false
					},
					"Rule 30":{
						color:[255,0,255,255],
						pattern:"Rule 30",
					},
					"Rule 90":{
						color:[147,112,219,255],
						pattern:"Rule 90",
					},
					"Rule 110":{
						color:[128,0,128,255],
						pattern:"Rule 110",
					},
					"Rule 184":{
						color:[255,51,153,255],
						pattern:"Rule 184",
					},
					"Water":{
						color:[23,103,167,255],
						liveCell:function(rel) {
							var rands_water=new Uint8Array(2)
							window.crypto.getRandomValues(rands_water);
							var newx=rel.x+(rands_water[0]%3)-1,
								newy=rel.y+rands_water[1]%4,
								h=p.get_height()
							while((newy>=h||!p.confirmElm(newx,newy,p.defaultId,false))&&newy-1>=rel.y)
								newy--
							if(p.confirmElm(newx,newy,p.defaultId,false)){
								p.setPixel(rel.x,rel.y,p.defaultId,false);
								p.setPixel(newx,newy,rel.oldId,false)
							}
						},
					},//*/
				});
				onZoomClick=function(e,rel) {//an event-like function that returns what should be set where the zoom ctx was clicked
					//console.log("onZoomClick",arguments);
					var active;
					if (e.ctrlKey) active=document.getElementById("ctrlSelect").value;
					else if(e.altKey) active=document.getElementById("altSelect").value;
					else active=document.getElementById("normalSelect").value
					if (p.confirmElm(rel.x,rel.y,active)) active=p.defaultId;
					return active;
				};
				function zoomClick(e) {
					//console.log("zoomClick",e);
					var zoomXPos=Math.floor(e.offsetX/window.pixelManipulator.zoomScaleFactor)+Math.floor(window.pixelManipulator.zoomX-(window.pixelManipulator.zoomScaleFactor/2)),
						zoomYPos=Math.floor(e.offsetY/window.pixelManipulator.zoomScaleFactor)+Math.floor(window.pixelManipulator.zoomY-(window.pixelManipulator.zoomScaleFactor/2));
					//console.log(zoomXPos,"=Math.floor(",e.offsetX,"/",window.pixelManipulator.zoomScaleFactor,")+Math.floor(",window.pixelManipulator.zoomX,"-(",window.pixelManipulator.zoomScaleFactor,"/",2,"))");
					//console.log(zoomYPos,"=Math.floor(",e.offsetY,"/",window.pixelManipulator.zoomScaleFactor,")+Math.floor(",window.pixelManipulator.zoomY,"-(",window.pixelManipulator.zoomScaleFactor,"/",2,"))");
					window.pixelManipulator.setPixel(zoomXPos,zoomYPos,//Where to set the pixel
						onZoomClick(e,//pass in the click event
							{x:zoomXPos,y:zoomYPos}));//as well as the position on the main canvas that this click was regestered to be at
					window.pixelManipulator.update();
					window.pixelManipulator.zoom({
						x:window.pixelManipulator.zoomX,
						y:window.pixelManipulator.zoomY,
					});
				}
				p.onIterate=function() {
					if (timedebug) lasttime=performance.now();
					frames++;
				}
				p.onAfterIterate=function() {
					if (!document.getElementById('pixelCounterT').checked) {
						//for (var timei=0,avrge=0;timei<times.length;timei++) { avrge+=times[timei]; } avrge/=times.length;
						//console.log(1/(avrge/1000));
						document.getElementById("pixelCounter").innerText=JSON.stringify(p.pixelCounts).replace(/[{}"]/g,"").replace(/,/g,"\n").replace(/:/g," : ")+
							"\n\nFrames:"+frames+
							(timedebug?("\nFps:"+(1/((performance.now()-lasttime)/1000))):"");
					}else document.getElementById("pixelCounter").innerText="";
					//times.push(performance.now()-lasttime);
				}
				document.getElementById('pixelCounterT').addEventListener('click',p.onAfterIterate);
				document.getElementById("play").addEventListener('click',function() {
					p.play();
					document.getElementById('play').disabled = true;
					document.getElementById('pause').disabled = false;
				});
				document.getElementById("reset").addEventListener('click',function() {
					p.reset({
						canvasW:document.getElementById("width").value||100,
						canvasH:document.getElementById("height").value||100,
						zoomW:document.getElementById("zoomWidthElm").value||20,
						zoomH:document.getElementById("zoomHeightElm").value||20,
					});//Reccomended to have a function here that sets the canvas size here (or earlier), due to how startup works.
					updateBox();
					document.getElementById('play').disabled = false;
					document.getElementById('oneFrameAtATime').disabled = false;
					document.getElementById('reset').disabled = false;
					document.getElementById('pause').disabled = true;
					frames=0;
					p.iterate();//this will prevent new user confusion by showing the zoom box when the page loads
				});
				document.getElementById('reset').click();
				document.getElementById("pause").addEventListener('click',function() {
					document.getElementById('pause').disabled = true;
					document.getElementById('play').disabled = false;
					p.pause();
				});
				document.getElementById("normalFill").addEventListener('click',function() {
					var pr=document.getElementById("normalFillP").value||15;
					p.randomlyFill(pr,document.getElementById("normalSelect").value);
					p.update();//needed after any changes are made
				});
				document.getElementById("ctrlFill").addEventListener('click',function() {
					var pr=document.getElementById("ctrlFillP").value||15;
					p.randomlyFill(pr,document.getElementById("ctrlSelect").value);
					p.update();
				});
				document.getElementById("altFill").addEventListener('click',function() {
					var pr=document.getElementById("altFillP").value||15;
					p.randomlyFill(pr,document.getElementById("altSelect").value);
					p.update();
				});
				var elmdrops=document.getElementsByClassName("elmDrop")
				for (var i=0;i<elmdrops.length;i++){
					for (var elementName in p.elementTypeMap) {
						var newElement=document.createElement("option")
						newElement.innerText=elementName
						elmdrops[i].appendChild(newElement)
					}
				}
				document.getElementById("normalSelect").value="Conway's Game Of Life"
				document.getElementById("ctrlSelect").value="Blocks"
				document.getElementById("altSelect").value="Water"
			});
		</script>
	</body>
</html>
